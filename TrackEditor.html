<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Track editor</title>
	<link rel="stylesheet" type="text/css" href="css/trackEditorStyle.css">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</head>
<body>

	<div id="trackForm">
		<fieldset> <legend>Track info</legend>
			<br>
			<label>Track name: </label><input type="text" id="nameInput" >
			<label>Track tempo: </label><input type="number" id="tempoInput">
			<br>
			<label>Time signiature: </label><input type="text" id="timeSigniatureInput">
			<label>Number of bars: </label><input type="number" id="lengthInput">
		</fieldset>
		
		<br><br>
		
		<fieldset> <legend>Track sections</legend>
		<br>
		<button id="sectionBtn">Create a new section</button>
		<button id="removeSectionBtn" style="margin-left:20px">Remove last section</button>
		<input type="file" id="openFileBtn" enctype="multipart/form-data" style="float: right; margin-right: 20px; width: 180px;"/>
		<a id="saveTrackBtn" style="float: right; margin-right: 20px" href="" download="">Save track</a>
		
		</fieldset>
	</div>
	
	<script>
		var generatedTrack;
		var sectionId = 0;
		var chordIds = [];
		
		var ROOT_NOTES = ["C", "E", "G"]; // read from file
		var root_insert_HTML = "";
		
		var CHORD_TYPES = ["major", "minor", "maj7"]; // read from file
		var type_insert_HTML = "";
		
		var CHORD_DURATION = ["whole", "half", "quater", "eigth", "sixteenth"]; // read from file
		var duration_insert_HTML = "";
		
		var CHORD_MULTIPLIERS = [1,2,3,4,5,6,7,8,9,10];
		var multiplier_insert_HTML = "";
	
		function addChord(component, sectionId) {
			// insert root label and selector
			var insertChordHTML = '<section id="chordSection_'+sectionId+'_'+chordIds[sectionId]+'"><label>Root note: </label><select id="root_'+sectionId+'_'+chordIds[sectionId]+'">';
			insertChordHTML += root_insert_HTML;

			// insert type label and selector
			insertChordHTML += '</select><label>Chord type: </label><select id="type_'+sectionId+'_'+chordIds[sectionId]+'">';
			insertChordHTML += type_insert_HTML;

			// insert duration label, multiplier and selector
			insertChordHTML += '</select><label>Chord duration: </label>';
			insertChordHTML += '<select id="multiplier_'+sectionId+'_'+chordIds[sectionId]+'">' + multiplier_insert_HTML + '</select>';
			insertChordHTML += '<select id="duration_'+sectionId+'_'+chordIds[sectionId]+'">' + duration_insert_HTML + '</select>';

			// insert checpoint label and selector
			insertChordHTML += '<label>Checkpoint: </label><select id="checkpoint_'+sectionId+'_'+chordIds[sectionId]+'"><option value="true">true</option><option value="false">false</option></select></section>';
				
			$(component).before(insertChordHTML);
			chordIds[sectionId]++;
		};

		function removeChord(sectionId) {
			var id = chordIds[sectionId] - 1;
			if(chordIds[sectionId] > 0) {
				$("#chordSection_"+sectionId+"_"+id).remove();
				chordIds[sectionId]--;
			}
		};
		
		function addSection(component) {

			chordIds.push(0);			
			var insertSectionHTML = 
				'<fieldset id="section_'+sectionId+'"><legend>Section '+ sectionId + '</legend><br>'+
				'<label>Section name: </label><input type="text" id="sectionName_'+sectionId+'">'+
				'<label>Number of iterations: </label><input type="number" id="sectionIterations_'+sectionId+'">'+
				'<hr><br>'+
				'<button id="addChordBtn_'+sectionId+'" onclick="addChord(this,'+sectionId+')" class="addChordBtn">Add chord</button>'+
				'<button id="removeChord_'+sectionId+'" onclick="removeChord('+sectionId+')" class="removeChordBtn">Remove last chord</button>'+
				'</fieldset><br class="break_'+sectionId+'"><br class="break_'+sectionId+'">';
			
			$(component).before(insertSectionHTML);
			sectionId++;
		};

		function removeSection() {
			if(sectionId > 0) {
				var id = sectionId - 1;
				$("#section_"+id).fadeOut(300, function(){
					$(".break_"+id).remove();
					$(this).remove();
					sectionId--;
				});		
			}
		};

		function generateTrack() {

			var wholeNoteDuration = 240 / $("#tempoInput").val();
			var preload = [];
			var sections = [];		
			var noteDurations = 
				{
					"whole": wholeNoteDuration,
					"half": wholeNoteDuration / 2,
					"quater": wholeNoteDuration / 4,
				 	"eigth": wholeNoteDuration / 8,
				 	"sixteenth": wholeNoteDuration / 16
				};	
	
			for(var i=0; i<sectionId; i++) {
				var chords=[];
				for(var j=0; j<chordIds[i]; j++) { 
					var name = $("#root_"+i+"_"+j).val() + "-" + $("#type_"+i+"_"+j).val();
					chords.push( 
						{
							name: name, // probably ne rabmo
							root: $("#root_"+i+"_"+j).val(),
							type: $("#type_"+i+"_"+j).val(),
							multiplier:  $("#multiplier_"+i+"_"+j).val(),
							duration: $("#duration_"+i+"_"+j).val(),
							time_duration: $("#multiplier_"+i+"_"+j).val() * noteDurations[$("#duration_"+i+"_"+j).val()],
							checkpoint: $("#checkpoint_"+i+"_"+j).val()
						});

					if($.inArray(name, preload) == -1)
						preload.push(name);
				}

				sections.push( {name: $("#sectionName_"+i).val(), iterations: $("#sectionIterations_"+i).val(), chords: chords} );			
			}
			
			generatedTrack = 
			{
				info:
					{
						name: $("#nameInput").val(),
						tempo: $("#tempoInput").val(),
						timeSigniature: $("#timeSigniatureInput").val(),
						numBars: $("#lengthInput").val(),
						length: wholeNoteDuration * $("#lengthInput").val()
					},
				preload: preload,
				noteDurations: noteDurations,
				sections: sections	
			};

			console.log(generatedTrack);
		};

		function saveTrack() {
			var data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(generatedTrack));
			$("#saveTrackBtn").attr("href", "data:" + data);
			$("#saveTrackBtn").attr("download", "ChordBrah_"+generatedTrack.info.name+".json");
		};

		function clearEditor() {
			var num = sectionId;
			for(var i=0; i<num; i++) {
				var id = sectionId - 1;
				$(".break_"+id).remove();
				$("#section_"+id).remove();
				sectionId--;			
			}

			chordIds = [];
		}
		
		function displayTrack(track) {
			// Track info
			$("#nameInput").val(track.info.name);
			$("#tempoInput").val(track.info.tempo);
			$("#timeSigniatureInput").val(track.info.timeSigniature);
			$("#lengthInput").val(track.info.numBars);

			// Track sections
			for(var i=0; i<track.sections.length; i++) {
				
				// Create new section
				addSection("#sectionBtn");

				// Section info				
				$("#sectionName_"+i).val(track.sections[i].name);
				$("#sectionIterations_"+i).val(track.sections[i].iterations);
			
				// Create chords
				for(var j=0; j<track.sections[i].chords.length; j++) {

					// Create new chord
					addChord($("#addChordBtn_"+i), i);
					// Do the selections
					$("#root_"+i+"_"+j).val(track.sections[i].chords[j].root);
					$("#type_"+i+"_"+j).val(track.sections[i].chords[j].type);
					$("#multiplier_"+i+"_"+j).val(track.sections[i].chords[j].multiplier);
					$("#duration_"+i+"_"+j).val(track.sections[i].chords[j].duration);
					$("#checkpoint_"+i+"_"+j).val(track.sections[i].chords[j].checkpoint);
				}
			}
		};

		function openTrack(evt) {
			var files = evt.target.files;
	        var file = files[0];           
	        var reader = new FileReader();
	        reader.onload = function() {
				clearEditor();
				displayTrack(jQuery.parseJSON(this.result));            
	        }
	        reader.readAsText(file)
		};
		
 		$(document).ready(function() {
 	 		
 			for(var i=0; i < ROOT_NOTES.length; i++)
 				root_insert_HTML += '<option value="'+ROOT_NOTES[i]+'">'+ROOT_NOTES[i]+'</option>';

 			for(var i=0; i < CHORD_TYPES.length; i++)
 				type_insert_HTML += '<option value="'+CHORD_TYPES[i]+'">'+CHORD_TYPES[i]+'</option>';

 			for(var i=0; i < CHORD_DURATION.length; i++)				
 				duration_insert_HTML += '<option value="'+CHORD_DURATION[i]+'">'+CHORD_DURATION[i]+'</option>';
 				
 			for(var i=0; i < CHORD_MULTIPLIERS.length; i++)			
 				multiplier_insert_HTML += '<option value="'+CHORD_MULTIPLIERS[i]+'">'+CHORD_MULTIPLIERS[i]+'</option>';

			$("#sectionBtn").click(function() {
				addSection(this);
			});

			$("#removeSectionBtn").click(function() {
				removeSection();
			});

			$("#saveTrackBtn").click(function() {
				generateTrack();
				saveTrack();
			});

			document.getElementById('openFileBtn').addEventListener('change', openTrack, false);
			/*$("#openFileBtn").click(function() ) {
				openTrack();
			});*/
			
 		});
	</script>
	
</body>
</html>